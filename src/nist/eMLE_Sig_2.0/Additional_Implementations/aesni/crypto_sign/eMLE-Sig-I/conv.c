#include <stdint.h>
#include <stdlib.h>
#include <string.h>
#include <stddef.h>
#include "conv.h"
#include "mod.h"

/* Layer 1 Karatsuba+schoolbook multiplication */
static inline void karatsuba_l1(int64_t *out, const int64_t *a, const int64_t *b, const size_t n_2)
{
    int64_t z[38] = {0};
    int64_t a1[19];
    int64_t b1[19];
    int64_t x;

    size_t i, j;

    for (i = 0; i < n_2; i++)
    {
        a1[i] = a[i] - a[i + n_2];
        b1[i] = b[i + n_2] - b[i];
    }

    for (i = 0; i < n_2; i++)
    {
        for (j = 0; j < n_2; j++)
        {
            out[i + j] = out[i + j] + a[i] * b[j];
            out[i + j + n_2 * 2] = out[i + j + n_2 * 2] + a[i + n_2] * b[j + n_2];
            z[i + j] = z[i + j] + a1[i] * b1[j];
        }
    }
    for (i = 0; i < n_2; i++)
    {
        x = out[i + n_2] + out[i + n_2 * 2];
        out[i + n_2] = x + out[i] + z[i];
        out[i + n_2 * 2] = x + out[i + n_2 * 3] + z[i + n_2];
    }
}

/* Layer 2 Karatsuba+schoolbook multiplication */
static inline void karatsuba_l2(int64_t *out, const int64_t *a, const int64_t *b, const size_t n_4)
{
    int64_t a1[32];
    int64_t b1[32];
    int64_t z[64] = {0};
    int64_t x;

    size_t i;

    karatsuba_l1(out, a, b, n_4);
    karatsuba_l1(out + n_4 * 4, a + n_4 * 2, b + n_4 * 2, n_4);

    for (i = 0; i < n_4 * 2; i++)
    {
        a1[i] = a[i] - a[i + n_4 * 2];
        b1[i] = b[i + n_4 * 2] - b[i];
    }
    karatsuba_l1(z, a1, b1, n_4);

    for (i = 0; i < n_4 * 2; i++)
    {
        x = out[i + n_4 * 2] + out[i + n_4 * 4];
        out[i + n_4 * 2] = x + out[i] + z[i];
        out[i + n_4 * 4] = x + out[i + n_4 * 6] + z[i + n_4 * 2];
    }
}

/* Layer 3 Karatsuba+schoolbook multiplication */
static void karatsuba_l3(int64_t *out, const int64_t *a, const int64_t *b, const size_t n_8)
{
    int64_t a1[64];
    int64_t b1[64];
    int64_t z[128] = {0};
    int64_t x;

    size_t i;

    karatsuba_l2(out, a, b, n_8);
    karatsuba_l2(out + n_8 * 8, a + n_8 * 4, b + n_8 * 4, n_8);

    for (i = 0; i < n_8 * 4; i++)
    {
        a1[i] = a[i] - a[i + n_8 * 4];
        b1[i] = b[i + n_8 * 4] - b[i];
    }
    karatsuba_l2(z, a1, b1, n_8);

    for (i = 0; i < n_8 * 4; i++)
    {
        x = out[i + n_8 * 4] + out[i + n_8 * 8];
        out[i + n_8 * 4] = x + out[i] + z[i];
        out[i + n_8 * 8] = x + out[i + n_8 * 12] + z[i + n_8 * 4];
    }
}

/* Kronecker substitution for n=64 */
static void pack_64_mod_5(int64_t *out, const int64_t *a)
{
    out[0]=(a[0])|(a[1]<<11)|(a[2]<<22);
    out[1]=(a[3]<<4)|(a[4]<<15)|(a[5]<<26);
    out[2]=(a[6]<<8)|(a[7]<<19);
    out[3]=(a[8]<<1)|(a[9]<<12)|(a[10]<<23);
    out[4]=(a[11]<<5)|(a[12]<<16)|((a[13]&3)<<27);
    out[5]=(a[13]>>2)|(a[14]<<9)|(a[15]<<20);
    out[6]=(a[16]<<2)|(a[17]<<13)|(a[18]<<24);
    out[7]=(a[19]<<6)|(a[20]<<17)|((a[21]&1)<<28);
    out[8]=(a[21]>>1)|(a[22]<<10)|(a[23]<<21);
    out[9]=(a[24]<<3)|(a[25]<<14)|(a[26]<<25);
    out[10]=(a[27]<<7)|(a[28]<<18);
    out[11]=(a[29])|(a[30]<<11)|(a[31]<<22);
    out[12]=(a[32]<<4)|(a[33]<<15)|(a[34]<<26);
    out[13]=(a[35]<<8)|(a[36]<<19);
    out[14]=(a[37]<<1)|(a[38]<<12)|(a[39]<<23);
    out[15]=(a[40]<<5)|(a[41]<<16)|((a[42]&3)<<27);
    out[16]=(a[42]>>2)|(a[43]<<9)|(a[44]<<20);
    out[17]=(a[45]<<2)|(a[46]<<13)|(a[47]<<24);
    out[18]=(a[48]<<6)|(a[49]<<17)|((a[50]&1)<<28);
    out[19]=(a[50]>>1)|(a[51]<<10)|(a[52]<<21);
    out[20]=(a[53]<<3)|(a[54]<<14)|(a[55]<<25);
    out[21]=(a[56]<<7)|(a[57]<<18);
    out[22]=(a[58])|(a[59]<<11)|(a[60]<<22);
    out[23]=(a[61]<<4)|(a[62]<<15)|(a[63]<<26);
}

/* Kronecker unpacking for n=64 */
static void unpack_64_mod_5(int64_t *out, const int64_t *a)
{
    out[0]=mod_5((a[0]&2047)+((a[24]>>8)&2047));
    out[1]=mod_5(((a[0]>>11)&2047)+((a[24]>>19)|((a[25]&1)<<10)));
    out[2]=mod_5(((a[0]>>22)|((a[1]&15)<<7))+((a[25]>>1)&2047));
    out[3]=mod_5(((a[1]>>4)&2047)+((a[25]>>12)&2047));
    out[4]=mod_5(((a[1]>>15)&2047)+((a[25]>>23)|((a[26]&31)<<6)));
    out[5]=mod_5(((a[1]>>26)|((a[2]&255)<<3))+((a[26]>>5)&2047));
    out[6]=mod_5(((a[2]>>8)&2047)+((a[26]>>16)&2047));
    out[7]=mod_5(((a[2]>>19)|((a[3]&1)<<10))+((a[26]>>27)|((a[27]&511)<<2)));
    out[8]=mod_5(((a[3]>>1)&2047)+((a[27]>>9)&2047));
    out[9]=mod_5(((a[3]>>12)&2047)+((a[27]>>20)|((a[28]&3)<<9)));
    out[10]=mod_5(((a[3]>>23)|((a[4]&31)<<6))+((a[28]>>2)&2047));
    out[11]=mod_5(((a[4]>>5)&2047)+((a[28]>>13)&2047));
    out[12]=mod_5(((a[4]>>16)&2047)+((a[28]>>24)|((a[29]&63)<<5)));
    out[13]=mod_5(((a[4]>>27)|((a[5]&511)<<2))+((a[29]>>6)&2047));
    out[14]=mod_5(((a[5]>>9)&2047)+((a[29]>>17)&2047));
    out[15]=mod_5(((a[5]>>20)|((a[6]&3)<<9))+((a[29]>>28)|((a[30]&1023)<<1)));
    out[16]=mod_5(((a[6]>>2)&2047)+((a[30]>>10)&2047));
    out[17]=mod_5(((a[6]>>13)&2047)+((a[30]>>21)|((a[31]&7)<<8)));
    out[18]=mod_5(((a[6]>>24)|((a[7]&63)<<5))+((a[31]>>3)&2047));
    out[19]=mod_5(((a[7]>>6)&2047)+((a[31]>>14)&2047));
    out[20]=mod_5(((a[7]>>17)&2047)+((a[31]>>25)|((a[32]&127)<<4)));
    out[21]=mod_5(((a[7]>>28)|((a[8]&1023)<<1))+((a[32]>>7)&2047));
    out[22]=mod_5(((a[8]>>10)&2047)+((a[32]>>18)&2047));
    out[23]=mod_5(((a[8]>>21)|((a[9]&7)<<8))+((a[32]>>29)|((a[33]&2047)<<0)));
    out[24]=mod_5(((a[9]>>3)&2047)+((a[33]>>11)&2047));
    out[25]=mod_5(((a[9]>>14)&2047)+((a[33]>>22)|((a[34]&15)<<7)));
    out[26]=mod_5(((a[9]>>25)|((a[10]&127)<<4))+((a[34]>>4)&2047));
    out[27]=mod_5(((a[10]>>7)&2047)+((a[34]>>15)&2047));
    out[28]=mod_5(((a[10]>>18)&2047)+((a[34]>>26)|((a[35]&255)<<3)));
    out[29]=mod_5(((a[10]>>29)|((a[11]&2047)<<0))+((a[35]>>8)&2047));
    out[30]=mod_5(((a[11]>>11)&2047)+((a[35]>>19)|((a[36]&1)<<10)));
    out[31]=mod_5(((a[11]>>22)|((a[12]&15)<<7))+((a[36]>>1)&2047));
    out[32]=mod_5(((a[12]>>4)&2047)+((a[36]>>12)&2047));
    out[33]=mod_5(((a[12]>>15)&2047)+((a[36]>>23)|((a[37]&31)<<6)));
    out[34]=mod_5(((a[12]>>26)|((a[13]&255)<<3))+((a[37]>>5)&2047));
    out[35]=mod_5(((a[13]>>8)&2047)+((a[37]>>16)&2047));
    out[36]=mod_5(((a[13]>>19)|((a[14]&1)<<10))+((a[37]>>27)|((a[38]&511)<<2)));
    out[37]=mod_5(((a[14]>>1)&2047)+((a[38]>>9)&2047));
    out[38]=mod_5(((a[14]>>12)&2047)+((a[38]>>20)|((a[39]&3)<<9)));
    out[39]=mod_5(((a[14]>>23)|((a[15]&31)<<6))+((a[39]>>2)&2047));
    out[40]=mod_5(((a[15]>>5)&2047)+((a[39]>>13)&2047));
    out[41]=mod_5(((a[15]>>16)&2047)+((a[39]>>24)|((a[40]&63)<<5)));
    out[42]=mod_5(((a[15]>>27)|((a[16]&511)<<2))+((a[40]>>6)&2047));
    out[43]=mod_5(((a[16]>>9)&2047)+((a[40]>>17)&2047));
    out[44]=mod_5(((a[16]>>20)|((a[17]&3)<<9))+((a[40]>>28)|((a[41]&1023)<<1)));
    out[45]=mod_5(((a[17]>>2)&2047)+((a[41]>>10)&2047));
    out[46]=mod_5(((a[17]>>13)&2047)+((a[41]>>21)|((a[42]&7)<<8)));
    out[47]=mod_5(((a[17]>>24)|((a[18]&63)<<5))+((a[42]>>3)&2047));
    out[48]=mod_5(((a[18]>>6)&2047)+((a[42]>>14)&2047));
    out[49]=mod_5(((a[18]>>17)&2047)+((a[42]>>25)|((a[43]&127)<<4)));
    out[50]=mod_5(((a[18]>>28)|((a[19]&1023)<<1))+((a[43]>>7)&2047));
    out[51]=mod_5(((a[19]>>10)&2047)+((a[43]>>18)&2047));
    out[52]=mod_5(((a[19]>>21)|((a[20]&7)<<8))+((a[43]>>29)|((a[44]&2047)<<0)));
    out[53]=mod_5(((a[20]>>3)&2047)+((a[44]>>11)&2047));
    out[54]=mod_5(((a[20]>>14)&2047)+((a[44]>>22)|((a[45]&15)<<7)));
    out[55]=mod_5(((a[20]>>25)|((a[21]&127)<<4))+((a[45]>>4)&2047));
    out[56]=mod_5(((a[21]>>7)&2047)+((a[45]>>15)&2047));
    out[57]=mod_5(((a[21]>>18)&2047)+((a[45]>>26)|((a[46]&255)<<3)));
    out[58]=mod_5(((a[21]>>29)|((a[22]&2047)<<0))+((a[46]>>8)&2047));
    out[59]=mod_5(((a[22]>>11)&2047)+((a[46]>>19)|((a[47]&1)<<10)));
    out[60]=mod_5(((a[22]>>22)|((a[23]&15)<<7))+((a[47]>>1)&2047));
    out[61]=mod_5(((a[23]>>4)&2047)+((a[47]>>12)&2047));
    out[62]=mod_5(((a[23]>>15)&2047)+((a[47]>>23)|((a[48]&31)<<6)));
    out[63]=mod_5(((a[23]>>26)|((a[24]&255)<<3))+((a[48]>>5)&2047));
}

/* Convolution for n=64, modulus p=5 */
void conv_64_mod_5(int64_t *out, const int64_t *a, const int64_t *b)
{
    int64_t aa[64], bb[64];
    int64_t a_pack[24], b_pack[24], c_pack[49] = {0};

    size_t i;

    for (i = 0; i < 64; i++)
    {
        aa[i] = mod_5(a[i] + 10);
        bb[i] = mod_5(b[i] + 10);
    }

    pack_64_mod_5(a_pack, aa);
    pack_64_mod_5(b_pack, bb);

    karatsuba_l1(c_pack, a_pack, b_pack, 12);
    for (i = 1; i < 49; i++)
    {
        c_pack[i] += (c_pack[i - 1] >> 29);
        c_pack[i - 1] &= (1L << 29) - 1;
    }

    unpack_64_mod_5(out, c_pack);
}

/* Kronecker substitution for n=96 */
static void pack_96_mod_5(int64_t *out, const int64_t *a)
{
    out[0]=a[0]|(a[1]<<11)|(a[2]<<22);
    out[1]=(a[3]<<5)|(a[4]<<16)|((a[5]&1)<<27);
    out[2]=(a[5]>>1)|(a[6]<<10)|(a[7]<<21);
    out[3]=(a[8]<<4)|(a[9]<<15)|((a[10]&3)<<26);
    out[4]=(a[10]>>2)|(a[11]<<9)|(a[12]<<20);
    out[5]=(a[13]<<3)|(a[14]<<14)|(a[15]<<25);
    out[6]=(a[16]<<8)|(a[17]<<19);
    out[7]=(a[18]<<2)|(a[19]<<13)|(a[20]<<24);
    out[8]=(a[21]<<7)|(a[22]<<18);
    out[9]=(a[23]<<1)|(a[24]<<12)|(a[25]<<23);
    out[10]=(a[26]<<6)|(a[27]<<17);
    out[11]=a[28]|(a[29]<<11)|(a[30]<<22);
    out[12]=(a[31]<<5)|(a[32]<<16)|((a[33]&1)<<27);
    out[13]=(a[33]>>1)|(a[34]<<10)|(a[35]<<21);
    out[14]=(a[36]<<4)|(a[37]<<15)|((a[38]&3)<<26);
    out[15]=(a[38]>>2)|(a[39]<<9)|(a[40]<<20);
    out[16]=(a[41]<<3)|(a[42]<<14)|(a[43]<<25);
    out[17]=(a[44]<<8)|(a[45]<<19);
    out[18]=(a[46]<<2)|(a[47]<<13)|(a[48]<<24);
    out[19]=(a[49]<<7)|(a[50]<<18);
    out[20]=(a[51]<<1)|(a[52]<<12)|(a[53]<<23);
    out[21]=(a[54]<<6)|(a[55]<<17);
    out[22]=a[56]|(a[57]<<11)|(a[58]<<22);
    out[23]=(a[59]<<5)|(a[60]<<16)|((a[61]&1)<<27);
    out[24]=(a[61]>>1)|(a[62]<<10)|(a[63]<<21);
    out[25]=(a[64]<<4)|(a[65]<<15)|((a[66]&3)<<26);
    out[26]=(a[66]>>2)|(a[67]<<9)|(a[68]<<20);
    out[27]=(a[69]<<3)|(a[70]<<14)|(a[71]<<25);
    out[28]=(a[72]<<8)|(a[73]<<19);
    out[29]=(a[74]<<2)|(a[75]<<13)|(a[76]<<24);
    out[30]=(a[77]<<7)|(a[78]<<18);
    out[31]=(a[79]<<1)|(a[80]<<12)|(a[81]<<23);
    out[32]=(a[82]<<6)|(a[83]<<17);
    out[33]=a[84]|(a[85]<<11)|(a[86]<<22);
    out[34]=(a[87]<<5)|(a[88]<<16)|((a[89]&1)<<27);
    out[35]=(a[89]>>1)|(a[90]<<10)|(a[91]<<21);
    out[36]=(a[92]<<4)|(a[93]<<15)|((a[94]&3)<<26);
    out[37]=(a[94]>>2)|(a[95]<<9);
}

/* Kronecker unpacking for n=96 */
static void unpack_96_mod_5(int64_t *out, const int64_t *a)
{
    out[0]=mod_5((a[0]&2047)+((a[37]>>20)|((a[38]&7)<<8)));
    out[1]=mod_5(((a[0]>>11)&2047)+((a[38]>>3)&2047));
    out[2]=mod_5(((a[0]>>22)|((a[1]&31)<<6))+((a[38]>>14)&2047));
    out[3]=mod_5(((a[1]>>5)&2047)+((a[38]>>25)|((a[39]&255)<<3)));
    out[4]=mod_5(((a[1]>>16)&2047)+((a[39]>>8)&2047));
    out[5]=mod_5(((a[1]>>27)|((a[2]&1023)<<1))+((a[39]>>19)|((a[40]&3)<<9)));
    out[6]=mod_5(((a[2]>>10)&2047)+((a[40]>>2)&2047));
    out[7]=mod_5(((a[2]>>21)|((a[3]&15)<<7))+((a[40]>>13)&2047));
    out[8]=mod_5(((a[3]>>4)&2047)+((a[40]>>24)|((a[41]&127)<<4)));
    out[9]=mod_5(((a[3]>>15)&2047)+((a[41]>>7)&2047));
    out[10]=mod_5(((a[3]>>26)|((a[4]&511)<<2))+((a[41]>>18)|((a[42]&1)<<10)));
    out[11]=mod_5(((a[4]>>9)&2047)+((a[42]>>1)&2047));
    out[12]=mod_5(((a[4]>>20)|((a[5]&7)<<8))+((a[42]>>12)&2047));
    out[13]=mod_5(((a[5]>>3)&2047)+((a[42]>>23)|((a[43]&63)<<5)));
    out[14]=mod_5(((a[5]>>14)&2047)+((a[43]>>6)&2047));
    out[15]=mod_5(((a[5]>>25)|((a[6]&255)<<3))+((a[43]>>17)&2047));
    out[16]=mod_5(((a[6]>>8)&2047)+((a[43]>>28)|(a[44]&2047)));
    out[17]=mod_5(((a[6]>>19)|((a[7]&3)<<9))+((a[44]>>11)&2047));
    out[18]=mod_5(((a[7]>>2)&2047)+((a[44]>>22)|((a[45]&31)<<6)));
    out[19]=mod_5(((a[7]>>13)&2047)+((a[45]>>5)&2047));
    out[20]=mod_5(((a[7]>>24)|((a[8]&127)<<4))+((a[45]>>16)&2047));
    out[21]=mod_5(((a[8]>>7)&2047)+((a[45]>>27)|((a[46]&1023)<<1)));
    out[22]=mod_5(((a[8]>>18)|((a[9]&1)<<10))+((a[46]>>10)&2047));
    out[23]=mod_5(((a[9]>>1)&2047)+((a[46]>>21)|((a[47]&15)<<7)));
    out[24]=mod_5(((a[9]>>12)&2047)+((a[47]>>4)&2047));
    out[25]=mod_5(((a[9]>>23)|((a[10]&63)<<5))+((a[47]>>15)&2047));
    out[26]=mod_5(((a[10]>>6)&2047)+((a[47]>>26)|((a[48]&511)<<2)));
    out[27]=mod_5(((a[10]>>17)&2047)+((a[48]>>9)&2047));
    out[28]=mod_5(((a[10]>>28)|(a[11]&2047))+((a[48]>>20)|((a[49]&7)<<8)));
    out[29]=mod_5(((a[11]>>11)&2047)+((a[49]>>3)&2047));
    out[30]=mod_5(((a[11]>>22)|((a[12]&31)<<6))+((a[49]>>14)&2047));
    out[31]=mod_5(((a[12]>>5)&2047)+((a[49]>>25)|((a[50]&255)<<3)));
    out[32]=mod_5(((a[12]>>16)&2047)+((a[50]>>8)&2047));
    out[33]=mod_5(((a[12]>>27)|((a[13]&1023)<<1))+((a[50]>>19)|((a[51]&3)<<9)));
    out[34]=mod_5(((a[13]>>10)&2047)+((a[51]>>2)&2047));
    out[35]=mod_5(((a[13]>>21)|((a[14]&15)<<7))+((a[51]>>13)&2047));
    out[36]=mod_5(((a[14]>>4)&2047)+((a[51]>>24)|((a[52]&127)<<4)));
    out[37]=mod_5(((a[14]>>15)&2047)+((a[52]>>7)&2047));
    out[38]=mod_5(((a[14]>>26)|((a[15]&511)<<2))+((a[52]>>18)|((a[53]&1)<<10)));
    out[39]=mod_5(((a[15]>>9)&2047)+((a[53]>>1)&2047));
    out[40]=mod_5(((a[15]>>20)|((a[16]&7)<<8))+((a[53]>>12)&2047));
    out[41]=mod_5(((a[16]>>3)&2047)+((a[53]>>23)|((a[54]&63)<<5)));
    out[42]=mod_5(((a[16]>>14)&2047)+((a[54]>>6)&2047));
    out[43]=mod_5(((a[16]>>25)|((a[17]&255)<<3))+((a[54]>>17)&2047));
    out[44]=mod_5(((a[17]>>8)&2047)+((a[54]>>28)|(a[55]&2047)));
    out[45]=mod_5(((a[17]>>19)|((a[18]&3)<<9))+((a[55]>>11)&2047));
    out[46]=mod_5(((a[18]>>2)&2047)+((a[55]>>22)|((a[56]&31)<<6)));
    out[47]=mod_5(((a[18]>>13)&2047)+((a[56]>>5)&2047));
    out[48]=mod_5(((a[18]>>24)|((a[19]&127)<<4))+((a[56]>>16)&2047));
    out[49]=mod_5(((a[19]>>7)&2047)+((a[56]>>27)|((a[57]&1023)<<1)));
    out[50]=mod_5(((a[19]>>18)|((a[20]&1)<<10))+((a[57]>>10)&2047));
    out[51]=mod_5(((a[20]>>1)&2047)+((a[57]>>21)|((a[58]&15)<<7)));
    out[52]=mod_5(((a[20]>>12)&2047)+((a[58]>>4)&2047));
    out[53]=mod_5(((a[20]>>23)|((a[21]&63)<<5))+((a[58]>>15)&2047));
    out[54]=mod_5(((a[21]>>6)&2047)+((a[58]>>26)|((a[59]&511)<<2)));
    out[55]=mod_5(((a[21]>>17)&2047)+((a[59]>>9)&2047));
    out[56]=mod_5(((a[21]>>28)|(a[22]&2047))+((a[59]>>20)|((a[60]&7)<<8)));
    out[57]=mod_5(((a[22]>>11)&2047)+((a[60]>>3)&2047));
    out[58]=mod_5(((a[22]>>22)|((a[23]&31)<<6))+((a[60]>>14)&2047));
    out[59]=mod_5(((a[23]>>5)&2047)+((a[60]>>25)|((a[61]&255)<<3)));
    out[60]=mod_5(((a[23]>>16)&2047)+((a[61]>>8)&2047));
    out[61]=mod_5(((a[23]>>27)|((a[24]&1023)<<1))+((a[61]>>19)|((a[62]&3)<<9)));
    out[62]=mod_5(((a[24]>>10)&2047)+((a[62]>>2)&2047));
    out[63]=mod_5(((a[24]>>21)|((a[25]&15)<<7))+((a[62]>>13)&2047));
    out[64]=mod_5(((a[25]>>4)&2047)+((a[62]>>24)|((a[63]&127)<<4)));
    out[65]=mod_5(((a[25]>>15)&2047)+((a[63]>>7)&2047));
    out[66]=mod_5(((a[25]>>26)|((a[26]&511)<<2))+((a[63]>>18)|((a[64]&1)<<10)));
    out[67]=mod_5(((a[26]>>9)&2047)+((a[64]>>1)&2047));
    out[68]=mod_5(((a[26]>>20)|((a[27]&7)<<8))+((a[64]>>12)&2047));
    out[69]=mod_5(((a[27]>>3)&2047)+((a[64]>>23)|((a[65]&63)<<5)));
    out[70]=mod_5(((a[27]>>14)&2047)+((a[65]>>6)&2047));
    out[71]=mod_5(((a[27]>>25)|((a[28]&255)<<3))+((a[65]>>17)&2047));
    out[72]=mod_5(((a[28]>>8)&2047)+((a[65]>>28)|(a[66]&2047)));
    out[73]=mod_5(((a[28]>>19)|((a[29]&3)<<9))+((a[66]>>11)&2047));
    out[74]=mod_5(((a[29]>>2)&2047)+((a[66]>>22)|((a[67]&31)<<6)));
    out[75]=mod_5(((a[29]>>13)&2047)+((a[67]>>5)&2047));
    out[76]=mod_5(((a[29]>>24)|((a[30]&127)<<4))+((a[67]>>16)&2047));
    out[77]=mod_5(((a[30]>>7)&2047)+((a[67]>>27)|((a[68]&1023)<<1)));
    out[78]=mod_5(((a[30]>>18)|((a[31]&1)<<10))+((a[68]>>10)&2047));
    out[79]=mod_5(((a[31]>>1)&2047)+((a[68]>>21)|((a[69]&15)<<7)));
    out[80]=mod_5(((a[31]>>12)&2047)+((a[69]>>4)&2047));
    out[81]=mod_5(((a[31]>>23)|((a[32]&63)<<5))+((a[69]>>15)&2047));
    out[82]=mod_5(((a[32]>>6)&2047)+((a[69]>>26)|((a[70]&511)<<2)));
    out[83]=mod_5(((a[32]>>17)&2047)+((a[70]>>9)&2047));
    out[84]=mod_5(((a[32]>>28)|(a[33]&2047))+((a[70]>>20)|((a[71]&7)<<8)));
    out[85]=mod_5(((a[33]>>11)&2047)+((a[71]>>3)&2047));
    out[86]=mod_5(((a[33]>>22)|((a[34]&31)<<6))+((a[71]>>14)&2047));
    out[87]=mod_5(((a[34]>>5)&2047)+((a[71]>>25)|((a[72]&255)<<3)));
    out[88]=mod_5(((a[34]>>16)&2047)+((a[72]>>8)&2047));
    out[89]=mod_5(((a[34]>>27)|((a[35]&1023)<<1))+((a[72]>>19)|((a[73]&3)<<9)));
    out[90]=mod_5(((a[35]>>10)&2047)+((a[73]>>2)&2047));
    out[91]=mod_5(((a[35]>>21)|((a[36]&15)<<7))+((a[73]>>13)&2047));
    out[92]=mod_5(((a[36]>>4)&2047)+((a[73]>>24)|((a[74]&127)<<4)));
    out[93]=mod_5(((a[36]>>15)&2047)+((a[74]>>7)&2047));
    out[94]=mod_5(((a[36]>>26)|((a[37]&511)<<2))+((a[74]>>18)|((a[75]&1)<<10)));
    out[95]=mod_5(((a[37]>>9)&2047)+((a[75]>>1)&2047));
}

/* Convolution for n=96, modulus p=5 */
void conv_96_mod_5(int64_t *out, const int64_t *a, const int64_t *b)
{
    int64_t aa[96], bb[96];
    int64_t a_pack[38], b_pack[38], c_pack[76] = {0};

    size_t i;

    for (i = 0; i < 96; i++)
    {
        aa[i] = mod_5(a[i] + 10);
        bb[i] = mod_5(b[i] + 10);
    }

    pack_96_mod_5(a_pack, aa);
    pack_96_mod_5(b_pack, bb);

    karatsuba_l1(c_pack, a_pack, b_pack, 19);
    for (i = 1; i < 76; i++)
    {
        c_pack[i] += (c_pack[i - 1] >> 28);
        c_pack[i - 1] &= (1L << 28) - 1;
    }

    unpack_96_mod_5(out, c_pack);
}

/* Kronecker substitution for n=128 */
static void pack_128_mod_5(int64_t *out, const int64_t *a)
{
    out[0]=a[0]|(a[1]<<12)|(a[2]<<24);
    out[1]=(a[3]<<8)|(a[4]<<20);
    out[2]=(a[5]<<4)|(a[6]<<16);
    out[3]=a[7]|(a[8]<<12)|(a[9]<<24);
    out[4]=(a[10]<<8)|(a[11]<<20);
    out[5]=(a[12]<<4)|(a[13]<<16);
    out[6]=a[14]|(a[15]<<12)|(a[16]<<24);
    out[7]=(a[17]<<8)|(a[18]<<20);
    out[8]=(a[19]<<4)|(a[20]<<16);
    out[9]=a[21]|(a[22]<<12)|(a[23]<<24);
    out[10]=(a[24]<<8)|(a[25]<<20);
    out[11]=(a[26]<<4)|(a[27]<<16);
    out[12]=a[28]|(a[29]<<12)|(a[30]<<24);
    out[13]=(a[31]<<8)|(a[32]<<20);
    out[14]=(a[33]<<4)|(a[34]<<16);
    out[15]=a[35]|(a[36]<<12)|(a[37]<<24);
    out[16]=(a[38]<<8)|(a[39]<<20);
    out[17]=(a[40]<<4)|(a[41]<<16);
    out[18]=a[42]|(a[43]<<12)|(a[44]<<24);
    out[19]=(a[45]<<8)|(a[46]<<20);
    out[20]=(a[47]<<4)|(a[48]<<16);
    out[21]=a[49]|(a[50]<<12)|(a[51]<<24);
    out[22]=(a[52]<<8)|(a[53]<<20);
    out[23]=(a[54]<<4)|(a[55]<<16);
    out[24]=a[56]|(a[57]<<12)|(a[58]<<24);
    out[25]=(a[59]<<8)|(a[60]<<20);
    out[26]=(a[61]<<4)|(a[62]<<16);
    out[27]=a[63]|(a[64]<<12)|(a[65]<<24);
    out[28]=(a[66]<<8)|(a[67]<<20);
    out[29]=(a[68]<<4)|(a[69]<<16);
    out[30]=a[70]|(a[71]<<12)|(a[72]<<24);
    out[31]=(a[73]<<8)|(a[74]<<20);
    out[32]=(a[75]<<4)|(a[76]<<16);
    out[33]=a[77]|(a[78]<<12)|(a[79]<<24);
    out[34]=(a[80]<<8)|(a[81]<<20);
    out[35]=(a[82]<<4)|(a[83]<<16);
    out[36]=a[84]|(a[85]<<12)|(a[86]<<24);
    out[37]=(a[87]<<8)|(a[88]<<20);
    out[38]=(a[89]<<4)|(a[90]<<16);
    out[39]=a[91]|(a[92]<<12)|(a[93]<<24);
    out[40]=(a[94]<<8)|(a[95]<<20);
    out[41]=(a[96]<<4)|(a[97]<<16);
    out[42]=a[98]|(a[99]<<12)|(a[100]<<24);
    out[43]=(a[101]<<8)|(a[102]<<20);
    out[44]=(a[103]<<4)|(a[104]<<16);
    out[45]=a[105]|(a[106]<<12)|(a[107]<<24);
    out[46]=(a[108]<<8)|(a[109]<<20);
    out[47]=(a[110]<<4)|(a[111]<<16);
    out[48]=a[112]|(a[113]<<12)|(a[114]<<24);
    out[49]=(a[115]<<8)|(a[116]<<20);
    out[50]=(a[117]<<4)|(a[118]<<16);
    out[51]=a[119]|(a[120]<<12)|(a[121]<<24);
    out[52]=(a[122]<<8)|(a[123]<<20);
    out[53]=(a[124]<<4)|(a[125]<<16);
    out[54]=a[126]|(a[127]<<12);
    out[55]=0;
}

/* Kronecker unpacking for n=128 */
static void unpack_128_mod_5(int64_t *out, const int64_t *a)
{
    out[0]=mod_5((a[0]&4095)+((a[54]>>24)|((a[55]&255)<<4)));
    out[1]=mod_5(((a[0]>>12)&4095)+((a[55]>>8)&4095));
    out[2]=mod_5(((a[0]>>24)|((a[1]&255)<<4))+((a[55]>>20)|((a[56]&15)<<8)));
    out[3]=mod_5(((a[1]>>8)&4095)+((a[56]>>4)&4095));
    out[4]=mod_5(((a[1]>>20)|((a[2]&15)<<8))+((a[56]>>16)&4095));
    out[5]=mod_5(((a[2]>>4)&4095)+((a[56]>>28)|(a[57]&4095)));
    out[6]=mod_5(((a[2]>>16)&4095)+((a[57]>>12)&4095));
    out[7]=mod_5(((a[2]>>28)|(a[3]&4095))+((a[57]>>24)|((a[58]&255)<<4)));
    out[8]=mod_5(((a[3]>>12)&4095)+((a[58]>>8)&4095));
    out[9]=mod_5(((a[3]>>24)|((a[4]&255)<<4))+((a[58]>>20)|((a[59]&15)<<8)));
    out[10]=mod_5(((a[4]>>8)&4095)+((a[59]>>4)&4095));
    out[11]=mod_5(((a[4]>>20)|((a[5]&15)<<8))+((a[59]>>16)&4095));
    out[12]=mod_5(((a[5]>>4)&4095)+((a[59]>>28)|(a[60]&4095)));
    out[13]=mod_5(((a[5]>>16)&4095)+((a[60]>>12)&4095));
    out[14]=mod_5(((a[5]>>28)|(a[6]&4095))+((a[60]>>24)|((a[61]&255)<<4)));
    out[15]=mod_5(((a[6]>>12)&4095)+((a[61]>>8)&4095));
    out[16]=mod_5(((a[6]>>24)|((a[7]&255)<<4))+((a[61]>>20)|((a[62]&15)<<8)));
    out[17]=mod_5(((a[7]>>8)&4095)+((a[62]>>4)&4095));
    out[18]=mod_5(((a[7]>>20)|((a[8]&15)<<8))+((a[62]>>16)&4095));
    out[19]=mod_5(((a[8]>>4)&4095)+((a[62]>>28)|(a[63]&4095)));
    out[20]=mod_5(((a[8]>>16)&4095)+((a[63]>>12)&4095));
    out[21]=mod_5(((a[8]>>28)|(a[9]&4095))+((a[63]>>24)|((a[64]&255)<<4)));
    out[22]=mod_5(((a[9]>>12)&4095)+((a[64]>>8)&4095));
    out[23]=mod_5(((a[9]>>24)|((a[10]&255)<<4))+((a[64]>>20)|((a[65]&15)<<8)));
    out[24]=mod_5(((a[10]>>8)&4095)+((a[65]>>4)&4095));
    out[25]=mod_5(((a[10]>>20)|((a[11]&15)<<8))+((a[65]>>16)&4095));
    out[26]=mod_5(((a[11]>>4)&4095)+((a[65]>>28)|(a[66]&4095)));
    out[27]=mod_5(((a[11]>>16)&4095)+((a[66]>>12)&4095));
    out[28]=mod_5(((a[11]>>28)|(a[12]&4095))+((a[66]>>24)|((a[67]&255)<<4)));
    out[29]=mod_5(((a[12]>>12)&4095)+((a[67]>>8)&4095));
    out[30]=mod_5(((a[12]>>24)|((a[13]&255)<<4))+((a[67]>>20)|((a[68]&15)<<8)));
    out[31]=mod_5(((a[13]>>8)&4095)+((a[68]>>4)&4095));
    out[32]=mod_5(((a[13]>>20)|((a[14]&15)<<8))+((a[68]>>16)&4095));
    out[33]=mod_5(((a[14]>>4)&4095)+((a[68]>>28)|(a[69]&4095)));
    out[34]=mod_5(((a[14]>>16)&4095)+((a[69]>>12)&4095));
    out[35]=mod_5(((a[14]>>28)|(a[15]&4095))+((a[69]>>24)|((a[70]&255)<<4)));
    out[36]=mod_5(((a[15]>>12)&4095)+((a[70]>>8)&4095));
    out[37]=mod_5(((a[15]>>24)|((a[16]&255)<<4))+((a[70]>>20)|((a[71]&15)<<8)));
    out[38]=mod_5(((a[16]>>8)&4095)+((a[71]>>4)&4095));
    out[39]=mod_5(((a[16]>>20)|((a[17]&15)<<8))+((a[71]>>16)&4095));
    out[40]=mod_5(((a[17]>>4)&4095)+((a[71]>>28)|(a[72]&4095)));
    out[41]=mod_5(((a[17]>>16)&4095)+((a[72]>>12)&4095));
    out[42]=mod_5(((a[17]>>28)|(a[18]&4095))+((a[72]>>24)|((a[73]&255)<<4)));
    out[43]=mod_5(((a[18]>>12)&4095)+((a[73]>>8)&4095));
    out[44]=mod_5(((a[18]>>24)|((a[19]&255)<<4))+((a[73]>>20)|((a[74]&15)<<8)));
    out[45]=mod_5(((a[19]>>8)&4095)+((a[74]>>4)&4095));
    out[46]=mod_5(((a[19]>>20)|((a[20]&15)<<8))+((a[74]>>16)&4095));
    out[47]=mod_5(((a[20]>>4)&4095)+((a[74]>>28)|(a[75]&4095)));
    out[48]=mod_5(((a[20]>>16)&4095)+((a[75]>>12)&4095));
    out[49]=mod_5(((a[20]>>28)|(a[21]&4095))+((a[75]>>24)|((a[76]&255)<<4)));
    out[50]=mod_5(((a[21]>>12)&4095)+((a[76]>>8)&4095));
    out[51]=mod_5(((a[21]>>24)|((a[22]&255)<<4))+((a[76]>>20)|((a[77]&15)<<8)));
    out[52]=mod_5(((a[22]>>8)&4095)+((a[77]>>4)&4095));
    out[53]=mod_5(((a[22]>>20)|((a[23]&15)<<8))+((a[77]>>16)&4095));
    out[54]=mod_5(((a[23]>>4)&4095)+((a[77]>>28)|(a[78]&4095)));
    out[55]=mod_5(((a[23]>>16)&4095)+((a[78]>>12)&4095));
    out[56]=mod_5(((a[23]>>28)|(a[24]&4095))+((a[78]>>24)|((a[79]&255)<<4)));
    out[57]=mod_5(((a[24]>>12)&4095)+((a[79]>>8)&4095));
    out[58]=mod_5(((a[24]>>24)|((a[25]&255)<<4))+((a[79]>>20)|((a[80]&15)<<8)));
    out[59]=mod_5(((a[25]>>8)&4095)+((a[80]>>4)&4095));
    out[60]=mod_5(((a[25]>>20)|((a[26]&15)<<8))+((a[80]>>16)&4095));
    out[61]=mod_5(((a[26]>>4)&4095)+((a[80]>>28)|(a[81]&4095)));
    out[62]=mod_5(((a[26]>>16)&4095)+((a[81]>>12)&4095));
    out[63]=mod_5(((a[26]>>28)|(a[27]&4095))+((a[81]>>24)|((a[82]&255)<<4)));
    out[64]=mod_5(((a[27]>>12)&4095)+((a[82]>>8)&4095));
    out[65]=mod_5(((a[27]>>24)|((a[28]&255)<<4))+((a[82]>>20)|((a[83]&15)<<8)));
    out[66]=mod_5(((a[28]>>8)&4095)+((a[83]>>4)&4095));
    out[67]=mod_5(((a[28]>>20)|((a[29]&15)<<8))+((a[83]>>16)&4095));
    out[68]=mod_5(((a[29]>>4)&4095)+((a[83]>>28)|(a[84]&4095)));
    out[69]=mod_5(((a[29]>>16)&4095)+((a[84]>>12)&4095));
    out[70]=mod_5(((a[29]>>28)|(a[30]&4095))+((a[84]>>24)|((a[85]&255)<<4)));
    out[71]=mod_5(((a[30]>>12)&4095)+((a[85]>>8)&4095));
    out[72]=mod_5(((a[30]>>24)|((a[31]&255)<<4))+((a[85]>>20)|((a[86]&15)<<8)));
    out[73]=mod_5(((a[31]>>8)&4095)+((a[86]>>4)&4095));
    out[74]=mod_5(((a[31]>>20)|((a[32]&15)<<8))+((a[86]>>16)&4095));
    out[75]=mod_5(((a[32]>>4)&4095)+((a[86]>>28)|(a[87]&4095)));
    out[76]=mod_5(((a[32]>>16)&4095)+((a[87]>>12)&4095));
    out[77]=mod_5(((a[32]>>28)|(a[33]&4095))+((a[87]>>24)|((a[88]&255)<<4)));
    out[78]=mod_5(((a[33]>>12)&4095)+((a[88]>>8)&4095));
    out[79]=mod_5(((a[33]>>24)|((a[34]&255)<<4))+((a[88]>>20)|((a[89]&15)<<8)));
    out[80]=mod_5(((a[34]>>8)&4095)+((a[89]>>4)&4095));
    out[81]=mod_5(((a[34]>>20)|((a[35]&15)<<8))+((a[89]>>16)&4095));
    out[82]=mod_5(((a[35]>>4)&4095)+((a[89]>>28)|(a[90]&4095)));
    out[83]=mod_5(((a[35]>>16)&4095)+((a[90]>>12)&4095));
    out[84]=mod_5(((a[35]>>28)|(a[36]&4095))+((a[90]>>24)|((a[91]&255)<<4)));
    out[85]=mod_5(((a[36]>>12)&4095)+((a[91]>>8)&4095));
    out[86]=mod_5(((a[36]>>24)|((a[37]&255)<<4))+((a[91]>>20)|((a[92]&15)<<8)));
    out[87]=mod_5(((a[37]>>8)&4095)+((a[92]>>4)&4095));
    out[88]=mod_5(((a[37]>>20)|((a[38]&15)<<8))+((a[92]>>16)&4095));
    out[89]=mod_5(((a[38]>>4)&4095)+((a[92]>>28)|(a[93]&4095)));
    out[90]=mod_5(((a[38]>>16)&4095)+((a[93]>>12)&4095));
    out[91]=mod_5(((a[38]>>28)|(a[39]&4095))+((a[93]>>24)|((a[94]&255)<<4)));
    out[92]=mod_5(((a[39]>>12)&4095)+((a[94]>>8)&4095));
    out[93]=mod_5(((a[39]>>24)|((a[40]&255)<<4))+((a[94]>>20)|((a[95]&15)<<8)));
    out[94]=mod_5(((a[40]>>8)&4095)+((a[95]>>4)&4095));
    out[95]=mod_5(((a[40]>>20)|((a[41]&15)<<8))+((a[95]>>16)&4095));
    out[96]=mod_5(((a[41]>>4)&4095)+((a[95]>>28)|(a[96]&4095)));
    out[97]=mod_5(((a[41]>>16)&4095)+((a[96]>>12)&4095));
    out[98]=mod_5(((a[41]>>28)|(a[42]&4095))+((a[96]>>24)|((a[97]&255)<<4)));
    out[99]=mod_5(((a[42]>>12)&4095)+((a[97]>>8)&4095));
    out[100]=mod_5(((a[42]>>24)|((a[43]&255)<<4))+((a[97]>>20)|((a[98]&15)<<8)));
    out[101]=mod_5(((a[43]>>8)&4095)+((a[98]>>4)&4095));
    out[102]=mod_5(((a[43]>>20)|((a[44]&15)<<8))+((a[98]>>16)&4095));
    out[103]=mod_5(((a[44]>>4)&4095)+((a[98]>>28)|(a[99]&4095)));
    out[104]=mod_5(((a[44]>>16)&4095)+((a[99]>>12)&4095));
    out[105]=mod_5(((a[44]>>28)|(a[45]&4095))+((a[99]>>24)|((a[100]&255)<<4)));
    out[106]=mod_5(((a[45]>>12)&4095)+((a[100]>>8)&4095));
    out[107]=mod_5(((a[45]>>24)|((a[46]&255)<<4))+((a[100]>>20)|((a[101]&15)<<8)));
    out[108]=mod_5(((a[46]>>8)&4095)+((a[101]>>4)&4095));
    out[109]=mod_5(((a[46]>>20)|((a[47]&15)<<8))+((a[101]>>16)&4095));
    out[110]=mod_5(((a[47]>>4)&4095)+((a[101]>>28)|(a[102]&4095)));
    out[111]=mod_5(((a[47]>>16)&4095)+((a[102]>>12)&4095));
    out[112]=mod_5(((a[47]>>28)|(a[48]&4095))+((a[102]>>24)|((a[103]&255)<<4)));
    out[113]=mod_5(((a[48]>>12)&4095)+((a[103]>>8)&4095));
    out[114]=mod_5(((a[48]>>24)|((a[49]&255)<<4))+((a[103]>>20)|((a[104]&15)<<8)));
    out[115]=mod_5(((a[49]>>8)&4095)+((a[104]>>4)&4095));
    out[116]=mod_5(((a[49]>>20)|((a[50]&15)<<8))+((a[104]>>16)&4095));
    out[117]=mod_5(((a[50]>>4)&4095)+((a[104]>>28)|(a[105]&4095)));
    out[118]=mod_5(((a[50]>>16)&4095)+((a[105]>>12)&4095));
    out[119]=mod_5(((a[50]>>28)|(a[51]&4095))+((a[105]>>24)|((a[106]&255)<<4)));
    out[120]=mod_5(((a[51]>>12)&4095)+((a[106]>>8)&4095));
    out[121]=mod_5(((a[51]>>24)|((a[52]&255)<<4))+((a[106]>>20)|((a[107]&15)<<8)));
    out[122]=mod_5(((a[52]>>8)&4095)+((a[107]>>4)&4095));
    out[123]=mod_5(((a[52]>>20)|((a[53]&15)<<8))+((a[107]>>16)&4095));
    out[124]=mod_5(((a[53]>>4)&4095)+((a[107]>>28)|(a[108]&4095)));
    out[125]=mod_5(((a[53]>>16)&4095)+((a[108]>>12)&4095));
    out[126]=mod_5(((a[53]>>28)|(a[54]&4095))+((a[108]>>24)|((a[109]&255)<<4)));
    out[127]=mod_5(((a[54]>>12)&4095)+((a[109]>>8)&4095));
}

/* Convolution for n=128, modulus p=5 */
void conv_128_mod_5(int64_t *out, const int64_t *a, const int64_t *b)
{
    int64_t aa[128], bb[128];
    int64_t a_pack[56], b_pack[56], c_pack[112] = {0};

    size_t i;

    for (i = 0; i < 128; i++)
    {
        aa[i] = mod_5(a[i] + 10);
        bb[i] = mod_5(b[i] + 10);
    }

    pack_128_mod_5(a_pack, aa);
    pack_128_mod_5(b_pack, bb);

    karatsuba_l2(c_pack, a_pack, b_pack, 14);
    for (i = 1; i < 110; i++)
    {
        c_pack[i] += (c_pack[i - 1] >> 28);
        c_pack[i - 1] &= (1L << 28) - 1;
    }

    unpack_128_mod_5(out, c_pack);
}

/* Convolution for n=64, modulus p=557 */
void conv_64_mod_557(int64_t *out, const int64_t *a, const int64_t *b)
{
    int64_t aa[64], bb[64], c[128] = {0};

    size_t i;

    for (i = 0; i < 64; i++)
    {
        aa[i] = mod_557(a[i] + 557);
        bb[i] = mod_557(b[i] + 557);
    }

    karatsuba_l2(c, aa, bb, 16);
    for (i = 0; i < 64; i++)
    {
        out[i] = mod_557(c[i] + c[i + 64]);
    }
}

/* Convolution for n=96, modulus p=823 */
void conv_96_mod_823(int64_t *out, const int64_t *a, const int64_t *b)
{
    int64_t aa[96], bb[96], c[192] = {0};

    size_t i;

    for (i = 0; i < 96; i++)
    {
        aa[i] = mod_823(a[i] + 823);
        bb[i] = mod_823(b[i] + 823);
    }

    karatsuba_l3(c, aa, bb, 12);
    for (i = 0; i < 96; i++)
    {
        out[i] = mod_823(c[i] + c[i + 96]);
    }
}

/* Convolution for n=128, modulus p=1097 */
void conv_128_mod_1097(int64_t *out, const int64_t *a, const int64_t *b)
{
    int64_t aa[128], bb[128], c[256] = {0};

    size_t i;

    for (i = 0; i < 128; i++)
    {
        aa[i] = mod_1097(a[i] + 1097);
        bb[i] = mod_1097(b[i] + 1097);
    }

    karatsuba_l3(c, aa, bb, 16);
    for (i = 0; i < 128; i++)
    {
        out[i] = mod_1097(c[i] + c[i + 128]);
    }
}

/* Layer 1 Karatsuba+schoolbook multiplication, with power-of-2 modulus */
static inline void karatsuba_l1_mod2(uint64_t *out, const uint64_t *a, const uint64_t *b, const size_t n_2, const uint64_t p)
{
    uint64_t z[32] = {0};
    uint64_t a1[16];
    uint64_t b1[16];
    uint64_t x;

    size_t i, j;

    for (i = 0; i < n_2; i++)
    {
        a1[i] = a[i] + a[i + n_2];
        b1[i] = b[i + n_2] + b[i];
    }

    for (i = 0; i < n_2; i++)
    {
        for (j = 0; j < n_2; j++)
        {
            out[i + j] = (out[i + j] + a[i] * b[j]) & (p - 1);
            out[i + j + n_2 * 2] = (out[i + j + n_2 * 2] + a[i + n_2] * b[j + n_2]) & (p - 1);
            z[i + j] = (z[i + j] + a1[i] * b1[j]) & (p - 1);
        }
    }
    for (i = 0; i < n_2; i++)
    {
        x = out[i + n_2] - out[i + n_2 * 2];
        out[i + n_2] = x - out[i] + z[i] + p * 2;
        out[i + n_2 * 2] = -x - out[i + n_2 * 3] + z[i + n_2] + p * 2;
    }
}

/* Layer 2 Karatsuba+schoolbook multiplication, with power-of-2 modulus */
static inline void karatsuba_l2_mod2(uint64_t *out, const uint64_t *a, const uint64_t *b, const size_t n_4, const uint64_t p)
{
    uint64_t a1[32];
    uint64_t b1[32];
    uint64_t z[64] = {0};
    uint64_t x;

    size_t i;

    karatsuba_l1_mod2(out, a, b, n_4, p);
    karatsuba_l1_mod2(out + n_4 * 4, a + n_4 * 2, b + n_4 * 2, n_4, p);

    for (i = 0; i < n_4 * 2; i++)
    {
        a1[i] = (a[i] + a[i + n_4 * 2]) & (p - 1);
        b1[i] = (b[i + n_4 * 2] + b[i]) & (p - 1);
    }
    karatsuba_l1_mod2(z, a1, b1, n_4, p);

    for (i = 0; i < n_4 * 2; i++)
    {
        x = out[i + n_4 * 2] - out[i + n_4 * 4];
        out[i + n_4 * 2] = x - out[i] + z[i] + p * 8;
        out[i + n_4 * 4] = -x - out[i + n_4 * 6] + z[i + n_4 * 2] + p * 8;
    }
}

/* Layer 3 Karatsuba+schoolbook multiplication, with power-of-2 modulus */
static void karatsuba_l3_mod2(uint64_t *out, const uint64_t *a, const uint64_t *b, const size_t n_8, const uint64_t p)
{
    uint64_t a1[64];
    uint64_t b1[64];
    uint64_t z[128] = {0};
    uint64_t x;

    size_t i;

    karatsuba_l2_mod2(out, a, b, n_8, p);
    karatsuba_l2_mod2(out + n_8 * 8, a + n_8 * 4, b + n_8 * 4, n_8, p);

    for (i = 0; i < n_8 * 4; i++)
    {
        a1[i] = (a[i] + a[i + n_8 * 4]) & (p - 1);
        b1[i] = (b[i + n_8 * 4] + b[i]) & (p - 1);
    }
    karatsuba_l2_mod2(z, a1, b1, n_8, p);

    for (i = 0; i < n_8 * 4; i++)
    {
        x = out[i + n_8 * 4] - out[i + n_8 * 8];
        out[i + n_8 * 4] = x - out[i] + z[i] + p * 32;
        out[i + n_8 * 8] = -x - out[i + n_8 * 12] + z[i + n_8 * 4] + p * 32;
    }
}

/* Convolution for n=64, modulus p=67108864 */
void conv_64_mod_67108864(int64_t *out, const int64_t *a, const int64_t *b)
{
    uint64_t aa[64], bb[64], c[128] = {0};

    size_t i;

    for (i = 0; i < 64; i++)
    {
        aa[i] = (a[i] + 67108864) & 67108863;
        bb[i] = (b[i] + 67108864) & 67108863;
    }

    karatsuba_l2_mod2(c, aa, bb, 16, 67108864);
    for (i = 0; i < 64; i++)
    {
        out[i] = (c[i] + c[i + 64]) & 67108863;
    }
}

/* Convolution for n=96, modulus p=268435456 */
void conv_96_mod_268435456(int64_t *out, const int64_t *a, const int64_t *b)
{
    uint64_t aa[96], bb[96], c[192] = {0};

    size_t i;

    for (i = 0; i < 96; i++)
    {
        aa[i] = (a[i] + 268435456) & 268435455;
        bb[i] = (b[i] + 268435456) & 268435455;
    }

    karatsuba_l3_mod2(c, aa, bb, 12, 268435456);
    for (i = 0; i < 96; i++)
    {
        out[i] = (c[i] + c[i + 96]) & 268435455;
    }
}

/* Convolution for n=128, modulus p=1073741824 */
void conv_128_mod_1073741824(int64_t *out, const int64_t *a, const int64_t *b)
{
    uint64_t aa[128], bb[128], c[256] = {0};

    size_t i;

    for (i = 0; i < 128; i++)
    {
        aa[i] = (a[i] + 1073741824) & 1073741823;
        bb[i] = (b[i] + 1073741824) & 1073741823;
    }

    karatsuba_l3_mod2(c, aa, bb, 16, 1073741824);
    for (i = 0; i < 128; i++)
    {
        out[i] = (c[i] + c[i + 128]) & 1073741823;
    }
}

/* Convolution for n=64 */
void conv_64(int64_t *out, const int64_t *a, const int64_t *b)
{
    int64_t c[128] = {0};

    size_t i;

    karatsuba_l2(c, a, b, 16);
    for (i = 0; i < 64; i++)
    {
        out[i] = c[i] + c[i + 64];
    }
}

/* Convolution for n=96 */
void conv_96(int64_t *out, const int64_t *a, const int64_t *b)
{
    int64_t c[192] = {0};

    size_t i;

    karatsuba_l3(c, a, b, 12);
    for (i = 0; i < 96; i++)
    {
        out[i] = c[i] + c[i + 96];
    }
}

/* Convolution for n=128 */
void conv_128(int64_t *out, const int64_t *a, const int64_t *b)
{
    int64_t c[256] = {0};

    size_t i;

    karatsuba_l3(c, a, b, 16);
    for (i = 0; i < 128; i++)
    {
        out[i] = c[i] + c[i + 128];
    }
}

/* Polynomial addition, with modulus p=5 */
static inline void add_n_mod_5(int64_t *out, const int64_t *a, const int64_t *b, const size_t n)
{
    size_t i;

    for (i = 0; i < n; i++)
    {
        out[i] = mod_5(a[i] + b[i] + 10);
    }
}

/* Polynomial addition, with power-of-2 modulus */
static inline void add_n_mod2(int64_t *out, const int64_t *a, const int64_t *b, const size_t n, const uint64_t p)
{
    size_t i;

    for (i = 0; i < n; i++)
    {
        out[i] = (a[i] + b[i] + p * 2) & (p - 1);
    }
}

/* Polynomial addition, with n=64 and modulus p=5 */
void add_64_mod_5(int64_t *out, const int64_t *a, const int64_t *b)
{
    add_n_mod_5(out, a, b, 64);
}

/* Polynomial addition, with n=64 and modulus p=557 */
void add_64_mod_557(int64_t *out, const int64_t *a, const int64_t *b)
{
    size_t i;

    for (i = 0; i < 64; i++)
    {
        out[i] = mod_557(a[i] + b[i] + 1114);
    }
}

/* Polynomial addition, with n=64 and modulus p=67108864 */
void add_64_mod_67108864(int64_t *out, const int64_t *a, const int64_t *b)
{
    add_n_mod2(out, a, b, 64, 67108864);
}

/* Polynomial addition, with n=96 and modulus p=5 */
void add_96_mod_5(int64_t *out, const int64_t *a, const int64_t *b)
{
    add_n_mod_5(out, a, b, 96);
}

/* Polynomial addition, with n=96 and modulus p=823 */
void add_96_mod_823(int64_t *out, const int64_t *a, const int64_t *b)
{
    size_t i;

    for (i = 0; i < 96; i++)
    {
        out[i] = mod_823(a[i] + b[i] + 1646);
    }
}

/* Polynomial addition, with n=96 and modulus p=268435456 */
void add_96_mod_268435456(int64_t *out, const int64_t *a, const int64_t *b)
{
    add_n_mod2(out, a, b, 96, 268435456);
}

/* Polynomial addition, with n=128 and modulus p=5 */
void add_128_mod_5(int64_t *out, const int64_t *a, const int64_t *b)
{
    add_n_mod_5(out, a, b, 128);
}

/* Polynomial addition, with n=128 and modulus p=1097 */
void add_128_mod_1097(int64_t *out, const int64_t *a, const int64_t *b)
{
    size_t i;

    for (i = 0; i < 128; i++)
    {
        out[i] = mod_1097(a[i] + b[i] + 2194);
    }
}

/* Polynomial addition, with n=128 and modulus p=1073741824 */
void add_128_mod_1073741824(int64_t *out, const int64_t *a, const int64_t *b)
{
    add_n_mod2(out, a, b, 128, 1073741824);
}
